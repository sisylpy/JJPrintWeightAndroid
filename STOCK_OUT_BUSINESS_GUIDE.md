# 4种出库模式数据保存网络请求业务指南

## 概述

本指南详细说明了客户出库页面中4种不同出库模式的完整业务流程，包括数据验证、网络请求、打印处理和错误处理。

## 4种出库模式

### 1. 无设备模式 (NO_DEVICE)
- **描述**: 手动输入重量，不连接任何设备
- **适用场景**: 设备故障或用户选择手动操作
- **业务流程**:
  1. 验证所有订单都有重量数据
  2. 直接保存数据到服务器
  3. 不进行打印操作
  4. 显示成功提示并刷新数据

### 2. 仅称模式 (SCALE_ONLY)
- **描述**: 蓝牙称连接，手动打印
- **适用场景**: 有称但无打印机，或打印机故障
- **业务流程**:
  1. 检查蓝牙称连接状态
  2. 验证所有订单都有重量数据
  3. 显示手动打印提示对话框
  4. 用户确认后保存数据到服务器
  5. 提示用户手动打印出库单

### 3. 仅打印机模式 (PRINTER_ONLY)
- **描述**: 蓝牙打印机连接，手动称重
- **适用场景**: 有打印机但无称，或称故障
- **业务流程**:
  1. 检查蓝牙打印机连接状态
  2. 验证所有订单都有重量数据
  3. 批量打印所有订单的出库单
  4. 打印成功后保存数据到服务器
  5. 显示成功提示并刷新数据

### 4. 双设备模式 (BOTH_DEVICES)
- **描述**: 蓝牙称和打印机都连接
- **适用场景**: 完整的自动化出库流程
- **业务流程**:
  1. 检查蓝牙称和打印机连接状态
  2. 验证所有订单都有重量数据
  3. 串行处理：先打印，再保存
  4. 每个订单单独打印和保存
  5. 显示成功提示并刷新数据

## 核心业务方法

### 1. 主入口方法
```java
processStockOutBusiness(List<NxDepartmentOrdersEntity> orders)
```
- 根据当前设备连接状态判断出库模式
- 调用对应的模式处理方法

### 2. 数据验证方法
```java
validateOrdersWithWeight(List<NxDepartmentOrdersEntity> orders)
```
- 验证所有订单都有有效的重量数据
- 返回有效的订单列表

### 3. 网络请求方法
```java
saveOrdersToServer(List<NxDepartmentOrdersEntity> orders, SaveCallback callback)
```
- 将订单数据转换为OrderWeightRequest格式
- 调用giveOrderWeightListForStockAndFinish接口
- 处理网络响应和错误

### 4. 打印处理方法
```java
printOrders(List<NxDepartmentOrdersEntity> orders, PrintCallback callback)
```
- 批量打印订单出库单
- 支持ESC和TSC两种打印指令
- 串行处理多个订单

## 数据模型

### OrderWeightRequest
```java
public class OrderWeightRequest {
    private int nxDepartmentOrdersId;    // 订单ID
    private Double nxDoWeight;           // 重量
    private int nxDoPickUserId;          // 拣货员ID
    private boolean hasChoice;           // 是否选中
}
```

### 网络接口
```java
@POST("api/nxdepartmentorders/giveOrderWeightListForStockAndFinish")
Observable<CommonResponse> confirmStockOut(@Body List<OrderWeightRequest> orders);
```

## 错误处理

### 1. 设备连接错误
- 检查设备连接状态
- 显示相应的错误提示
- 引导用户连接设备

### 2. 数据验证错误
- 检查订单重量数据完整性
- 提示用户补充缺失数据
- 阻止无效数据提交

### 3. 网络请求错误
- 捕获网络异常
- 显示错误信息
- 提供重试机制

### 4. 打印错误
- 检查打印机状态
- 处理打印异常
- 提供手动打印选项

## 用户界面交互

### 1. 模式状态显示
- 在页面标题显示当前出库模式
- 实时更新设备连接状态
- 提供模式切换提示

### 2. 进度提示
- 显示数据保存进度
- 显示打印进度
- 提供取消操作选项

### 3. 结果反馈
- 成功提示包含处理订单数量
- 失败提示包含具体错误信息
- 自动刷新数据列表

## 日志记录

### 1. 业务日志
- 记录出库模式选择
- 记录订单处理数量
- 记录成功/失败状态

### 2. 网络日志
- 记录请求参数
- 记录响应数据
- 记录错误信息

### 3. 设备日志
- 记录设备连接状态
- 记录打印操作
- 记录称重数据

## 性能优化

### 1. 异步处理
- 网络请求在后台线程执行
- UI更新在主线程执行
- 避免阻塞用户操作

### 2. 批量处理
- 支持批量订单处理
- 减少网络请求次数
- 提高处理效率

### 3. 错误恢复
- 支持部分失败恢复
- 提供重试机制
- 保持数据一致性

## 测试建议

### 1. 功能测试
- 测试4种模式的所有流程
- 验证数据保存正确性
- 检查打印输出质量

### 2. 异常测试
- 测试设备断开连接
- 测试网络异常情况
- 测试数据验证失败

### 3. 性能测试
- 测试大量订单处理
- 测试并发操作
- 测试内存使用情况

## 部署注意事项

### 1. 权限配置
- 确保蓝牙权限正确配置
- 确保网络权限正确配置
- 确保存储权限正确配置

### 2. 设备兼容性
- 测试不同蓝牙设备兼容性
- 测试不同打印机兼容性
- 测试不同Android版本兼容性

### 3. 网络环境
- 确保服务器接口可用
- 配置正确的网络超时时间
- 处理网络切换情况

## 维护和监控

### 1. 日志监控
- 监控业务处理成功率
- 监控设备连接稳定性
- 监控网络请求性能

### 2. 错误统计
- 统计各类错误发生频率
- 分析错误原因
- 优化错误处理逻辑

### 3. 用户反馈
- 收集用户使用反馈
- 优化用户体验
- 持续改进功能 